(kicad_sch (version 20210621) (generator eeschema)

  (uuid a7b63e36-66bf-4122-a092-51703a64af5d)

  (paper "B")

  (title_block
    (title "ConnectBox CM4 Battery Board - 4 Batteries")
    (date "2022-01-05")
    (rev "1.7.4")
    (comment 1 "JRA")
  )

  (lib_symbols
  )


  (text "Version 1.7.2 revealed the following issues which are corrected in 1.7.3\n- The battery reversed protection circuit didn't work. (Bulk diode issue)\n- If a battery is reversed, the I/O and ADC inputs are subject to \n   reverse biases exceeding the -0.5V limit. FIX: add schottkey\n   diodes to clamp the inputs to no more than -0.5V\n   (Digikey BAT54V-7DICT-ND ($0.16 @100) (2 diodes) is suitable)\n   https://www.diodes.com/assets/Datasheets/ds30560.pdf\n- An indicator for reversed batteries is desired\n- Consider replacement for L2 (4.7uH) in AXP209 charge path (height ??)\n- "
    (at 54.61 76.2 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid 5dc1f053-0ab0-4a93-8fdc-5bb868217ea8)
  )
  (text "1.7.3 required rework...\n- U5 change to CD4011 (NAND)\n- cut U5 pins 3, 4, 10, 11 (outputs)\n- cut Q1, Q4, Q7, Q10 jumper from pins 4-5 (gate - gate)\n- Add P-FET (4) with gate to U5 outputs (4), source\n   to Bat+, drain to 8205 pin 4 (gate) (4x)\n- Add second P-FET (4) with gate to U5 outputs (4), source \n   to Bat+, drain to 8205 pin 5 (gate) (4x)\n- Add 20K resistor from gate to Bat+ for each FET pair (4)\n- Add 20K (4) from 8205 pin 2 to 4\n- Add 20K (4) from 8205 pin 7 to 5\n- Replace R31 with jumper\n- cut connection to R31 of Q2, Q5, Q8, Q11 (pins 2,3)\n  (leave each pin 4-5 jumper in place)\n- Add 2.2K resistor from pins 2,3 of Q2, Q5, Q8, Q11 (4 resistor adds)\n   connecting the other end to the R31 jumper\n\n"
    (at 60.96 149.225 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid b3dc2ac5-a7f8-4919-a313-76649fa0a1e5)
  )
  (text "BOM Generation:\nUse the following for the path to python3:\n/Applications/KiCad/KiCad.app/Contents/Frameworks/Python.framework/Versions/3.8/bin/python3\n\nOpen the BOM dialog, choose the bom, in the bottom window just \npaste in the above path in place of the listed path to python3\n\nClick OK "
    (at 64.135 193.04 0)
    (effects (font (size 1.778 1.778)) (justify left bottom))
    (uuid afa57e40-04fb-43cf-9a8d-53695936ef14)
  )
  (text "Circuit Operation Notes:\n\n- Each battery cell is charged and discharged independently of the others by \n   connecting sequentially to the PWR_GND rail via a battery selection FET package\n- An ATTiny88AU microprocessor is used to control which cell is in use at any time\n- The ATTiny is powered by either +5V or AC_IN (steering diodes)\n- The ATTiny GND terminal is only connected to GND when +5V and/or AC_IN are present\n- During charging, the AC_IN line is at ~5V (sensed via ADC2) and the TTTiny \n   uses the BTx_ENA lines to apply charge current to the individual cells\n   sequentially in a round robin fashion\n- During discharge, the ATTTiny senses the +5V line is high and the AC_IN line \n   is low via ADC2 and controls the BTx_ENA lines to use individual cells for \n   discharge in a similar round robin fashion\n- Both during the charge and discharge situations, the ATTiny can read individual \n   battery voltages to determine both presence and charge levels and thus make \n   intelligent decisions as to charge need and availability for discharge\n- Without +5V or AC_IN present, the ATTiny is unpowered\n- All cells are protected against discharge due to reverse insertion via the FET pair used\n   to select that battery. A P channel FET constantly monitors the insertion direction, and \n   if incorrect, will disable operation of the battery enabling FET.\n"
    (at 149.7668 142.1569 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid 4b9c8dd2-6cc5-4bcf-a6a0-74ea3b51e61f)
  )
  (text "Circuit operation (con't):\n\n- When neither AC_IN or +5V are present, U5 (74HC126) goes tri-state, \n  isolating control FETs from the ATTiny88 and allowing their respective\n  gate-source resistors to control their state (turning on BT1 and \n  turning off BT2, BT3 and BT4\n- Battery indicators (blue LEDs) are tied to ground only through\n  the N-FET connecting the ATTiny gnd pin to GND, so are forced\n  off during power down\n- Leave U5 (74HC126) always powered \n- We will add pull ups (100K) to the control FETs to ensure all \n  Power FETs (except BAT1) are off when U4 is unpowered\n- We have a pull down resistor for the BAT1 control FETs\n  which is tied to BAT1 (-) to ensure BAT1 is on by\n  default (but can be turned off by U4 when it\n  is powered and U5 buffers are not in tri-state"
    (at 246.38 156.21 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid 5b90b42d-7db9-4b8d-8eba-34d3a7cb0f19)
  )
  (text "From StackExchange:\n\nI am using KiCAD 5.0.0 and as I refine my board design\n I often open Eeschema's Tools -> Annotate Schematic \ndialog and select the Reset existing annotations option. \nAfter doing this I load the newly generated netlist into \nPCBNew, making sure to select the Timestamp radio button \nin the PCBNew Netlist dialog. The Timestamp option tells \nPCBNew to select footprints based on their timestamp \nopposed to using the reference number which is the \n\"normal way\". This allows PCBNew to know that what \nwas R17 is now R12, what was C4 is now C2, etc."
    (at 291.465 50.8 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid 46e84ad5-e2e4-4873-baa7-856bda422a96)
  )
)
